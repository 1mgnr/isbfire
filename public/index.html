<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to Firebase Hosting</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/10.8.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/10.8.1/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-database-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-messaging-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-storage-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-analytics-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-remote-config-compat.js"></script>
    <script defer src="/__/firebase/10.8.1/firebase-performance-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="scores.html">Scores</a>
        <a href="score_detailed.html">Scores-2</a>

    </nav>

    <div class="chat-window">

        <div class="chat-container" id="chatContainer">
            <!-- Chat messages will be appended here -->
        </div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Type your message here">
            <button id="sendButton">Send</button>
        </div>
    </div>
    <!-- <button id="fetchHistoryButton">Fetch Chat History</button> -->

    <div id="sidebar">
        <button id="resetButton">Reset Chat</button>

    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
          const sidebar = document.getElementById('sidebar');
          const sendButton = document.getElementById('sendButton');
          const messageInput = document.getElementById('messageInput');
          const chatContainer = document.getElementById('chatContainer');
          const resetButton = document.getElementById('resetButton');
      
          function initializeChat() {
            attachEventListeners();
            fetchChatHistory();
            listenForNewMessages();
          }
      
          function attachEventListeners() {
            messageInput.addEventListener('keydown', handleInputKeyDown);
            sendButton.addEventListener('click', sendMessage);
            resetButton.addEventListener('click', resetChat);
          }
      
          function handleInputKeyDown(event) {
            if (event.key === 'Enter') {
              event.preventDefault();
              sendMessage();
            }
          }
      
          function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText) return;
      
            const messageData = {
              message: messageText,
              role: 'human',
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            };
      
            firebase.firestore().collection('messages').add(messageData)
              .then(() => {
                messageInput.value = '';
                scrollToBottom();
              })
              .catch((error) => console.error('Error sending message:', error));
          }
      
          function fetchChatHistory() {
            chatContainer.innerHTML = ''; // Clear the chat container
            firebase.firestore().collection('messages').orderBy('timestamp')
              .get()
              .then(querySnapshot => querySnapshot.forEach(doc => displayMessage(doc.data())))
              .catch(error => console.error('Error fetching chat history:', error));
          }
      
          function listenForNewMessages() {
            firebase.firestore().collection('messages').orderBy('timestamp')
              .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                  if (change.type === 'added') displayMessage(change.doc.data());
                });
                scrollToBottom();
              }, error => console.error('Error listening for new messages:', error));
          }
      
          function resetChat() {
            if (!confirm('Are you sure you want to reset the chat? This action cannot be undone.')) return;
      
            firebase.firestore().collection('messages').get().then(snapshot => {
              const batch = firebase.firestore().batch();
              snapshot.forEach(doc => batch.delete(doc.ref));
              return batch.commit();
            }).then(() => {
              console.log('All messages have been deleted.');
              fetchChatHistory(); // Fetch history to refresh the chat view
            }).catch(error => console.error('Error resetting chat:', error));
          }
      
          function displayMessage(data) {
            const messageEl = document.createElement('p');
            messageEl.textContent = data.message;
            messageEl.classList.add('message', data.role === 'human' ? 'send' : 'receive');
            chatContainer.appendChild(messageEl);
          }
      
          function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
      
          initializeChat();
        });
      </script>
</body>

</html>